---
title: "American Trends Panel - Wave 127"
subtitle: "An independent report on data gathered by the Pew Research Center"
author: "Nick B"
date: today
format: 
  html:
    toc: true
    toc-depth: 1
    toc-title: "Topics"
    # # code-tools: true          # Global code toggle - turned off due to issue w/ collapse sections
    # code-fold: true             # Allow folding
    # code-fold-default: false    # Hide code by default
    # code-summary: "Show Code"   # Optional button label
  pdf:
    echo: false
    toc: true
---

```{r notes}
#| eval: false
#| include: false

#This is my place for notes. It doesn't get displayed in the output docs. Just the code

# I want to add viewable source files to my sidepane.

# Add sections for TOC

# I might have messed up my metadata. Ensure I still have all the values and then organize properly.

```

```{r get-data-and-metadata}
#| message: false
#| include: false
#| echo: false
library(haven) #needed to read_sav
library(readxl)


data <- read_sav("../data/ATPW127/ATPW127.sav") #get data


metadata <- read_xlsx("../data/ATPmetadata.xlsx", sheet = "Codebook", skip = 2, col_names = TRUE) #brings in codebook


results <- read_xlsx("../data/results.xlsx")

```

This data report lets you independently explore the findings from Wave 127 of the American Trends Panel. The survey covered the internet, social media, and digital privacy and Black Lives Matter protests, the police, and patriotism. Results are weighted to reflect the U.S. adult population. 

{{< pagebreak >}}

```{r analysis}
#| include: false
#| eval: false
#| echo: false
library(dplyr)
library(tidyverse)
library(srvyr)
library(purrr)
library(haven) #for label zapping
library(labelled) #for labelling overall column

# Set analysis decisions
vars <- metadata %>% 
  filter(Item != "N/A") %>%
  distinct(Variable) %>%
  pull(Variable)

  
    var_labels <- map_dfr(vars, function(var) { # Get bivariate labels
    var_labels <- attr(data[[var]], "labels")
    var_labels <- data.frame(
        Variable = var,
        VarValue = as.numeric(var_labels),
        VarLabel = names(var_labels)
      )
    })
 


bivars <- metadata %>%
  filter(Type == "SUP") %>%
  filter(!Variable %in% c(
                      "F_CDIVISION", #Too granular - specific analysis variable
                      "F_HISP", # Accounted for in another variable 
                      "F_HISP_ORIGIN", #Too granular - specific analysis variable
                      "F_RACECMB", # Prefer F_RACETHNMOD
                      "F_BIRTHPLACE", #Use if interesting findings by F_CITIZEN
                      "F_MARITAL", # Specific analysis variable
                      "F_RELIG",  # Too granular
                      "F_ATTEND",  # Too granular
                      "F_PARTYSUMIDEO_FINAL", # prefer F_PARTY_SUM_FINAL & F_IDEO
                      "F_INC_SDT1" # Too granular
                      )) %>%
  distinct(Variable) %>%
  pull(Variable)





  data$OVERALL <- 1 #create overall column
  var_label(data$OVERALL) <- "Overall" #label overall column
  data$OVERALL <- labelled(data$OVERALL,
                           labels = c(
                             "Overall" = 1
                           ))
  
  bivars <- c("OVERALL", bivars)

    bivar_labels <- map_dfr(bivars, function(bivar) { # Get bivariate labels
    bivar_labels <- attr(data[[bivar]], "labels")
    bivar_labels <- data.frame(
        Bivariate = bivar,
        BivarValue = as.numeric(bivar_labels),
        BivarLabel = names(bivar_labels)
      )
    })


# Setup analysis

svy_data <- data %>% as_survey_design(ids = QKEY, weight = WEIGHT_W127) #setup survey analysis

# Run analysis
combos <- expand_grid(var = vars, bivar = bivars) #gets the combos

results <- combos %>%
  rowwise() %>% 
  mutate(
    results = list(
      svy_data %>%
        filter(across(all_of(c(var, bivar)), ~ !is.na(.))) %>% #remove missing values
        group_by(across(all_of(c(bivar, var)))) %>% #set level of aggregation
        summarise(proportion = survey_prop(vartype = "ci")) %>% #survey analysis
        mutate(Variable = var, 
               Bivariate = bivar,
               VariableLabel = metadata$Label[metadata$Variable == var][1],
               BivariateLabel = if (bivar == "OVERALL") {"Overall"} else metadata$Label[metadata$Variable == bivar][1],               
               Percent = round(proportion*100, 2),
               LB = round(proportion_low*100, 2),
               UB = round(proportion_upp*100, 2)
              ) %>%
        select(-proportion, -proportion_low, -proportion_upp) %>%
        rename(VarValue = var) %>% mutate(VarValue = zap_labels(VarValue)) %>%
        left_join(var_labels, by = c("Variable", "VarValue")) %>%   
        rename(BivarValue = bivar) %>% mutate(BivarValue = zap_labels(BivarValue)) %>%
        left_join(bivar_labels, by = c("Bivariate", "BivarValue")) %>%
        select(VariableLabel, Variable, VarValue, VarLabel, BivariateLabel, Bivariate, BivarValue, BivarLabel, Percent, LB, UB) 
    ),
  ) %>%
  ungroup() %>%
  unnest(results) %>% select(-var, -bivar)
  


#copy results to local file for preservation
library(writexl)

write_xlsx(results, "../data/results.xlsx")

# export results as formatted xlsx


```

```{r print-findings}
#| results: asis
#| echo: false

suppressMessages(library(dplyr))
library(knitr)
suppressWarnings(suppressMessages(library(kableExtra)))

sections <- unique(metadata$Section[!metadata$Section %in% c("PRELOAD", "Supplemental")])


for (sec in sections) {
  
  cat('# ',sec,' {.section-collapse}\n')
  # cat('::: {.callout-important collapse="true" icon="false"}\n') #starts callout note
  # cat('## ',sec,'\n')
    
  prev_section <- "" #Creates object needed for loop logic

  items <- unique(metadata$Item[metadata$Section == sec & metadata$Item != "N/A"])

  for (i in items) { # For each survey item, print item details and render results
    
    type_i <- metadata$Type[metadata$Item == i][1]

    if (type_i %in% c("Single-choice", "Single-choice w/ correct")) {

      output <- "VerticalBars"
      variables <- metadata$Variable[metadata$Item == i][1]
      variables <- paste(variables, collapse = ",")
      label <- metadata$Variable_Label[metadata$Item == i][1]
      universe <- metadata$Base[metadata$Item == i][1]
      
    cat('## ',label,' {.item-card}\n')
    cat('##### asked of ',universe,'\n')
    
    
    i_results <- results %>%
      filter(Variable == i & Bivariate == "OVERALL") %>%
      select(VarLabel, Percent)

    
    i_results <- kable(i_results,
                       col.names = c(" ", names(i_results)[-1])
                       )
    
    
    }

    if (type_i == "Series") {

      output <- "StackedBar"
      variables <- unique(metadata$Variable[metadata$Item == i])
      label <- metadata$Question[metadata$Item == i][1]
      universe <- metadata$Base[metadata$Item == i][1]
      
    cat('## ',label,' {.item-card}\n')
    cat('##### asked of ',universe,'\n')
    
    
    i_results <- results %>%
      filter(Variable %in% variables, Bivariate == "OVERALL") %>%
      select(VariableLabel, VarLabel, Percent)
    
      pack_index <- i_results %>%
        pull(VariableLabel) %>%              # get grouping variable as vector
        rle() %>%                       # find run lengths (successive identical values)
        { setNames(.$lengths, .$values) }   # named vector: group name â†’ # of rows
          
    i_results <- kable(i_results, 
                       col.names = c(names(i_results)[1], "", names(i_results)[-c(1, 2)])
                       ) %>%
                kable_styling(
                  position = "left") %>%
                pack_rows(index = pack_index) %>%
      { suppressWarnings(remove_column(., columns = 1)) }
    }
  
  print(i_results)
  
  } #closes item loop
  
  # cat('\n::: \n\n')

} #closes section loop

```

:::: {.content-visible when-format="html"}
```{r archived-tableau-findings}
#| results: asis
#| echo: false
#| include: false
#| eval: false

sections <- unique(metadata$Section[!metadata$Section %in% c("PRELOAD", "Supplemental")])


for (sec in sections) {
  cat('# ',sec,' {.hidden-header}\n')
  cat('::: {.callout-important collapse="true" icon="false"}\n') #starts callout note
  cat('## ',sec,'\n')
    
  prev_section <- "" #Creates object needed for loop logic

  items <- unique(metadata$Item[metadata$Section == sec & metadata$Item != "N/A"])

  for (i in items) { # For each survey item, print item details and render results
    
    type_i <- metadata$Type[metadata$Item == i][1]

    if (type_i %in% c("Single-choice", "Single-choice w/ correct")) {

      # Write dynamic content using paste0
      dash <- "BivariateDash"
      variables <- metadata$Variable[metadata$Item == i][1]
      variables <- paste(variables, collapse = ",")
      label <- URLencode(metadata$Variable_Label[metadata$Item == i][1], reserved = FALSE)
      label <- gsub(",", "|", label)
      universe <- metadata$Base[metadata$Item == i][1]


      height <- 500
    }

    if (type_i == "Series") {

      # Write dynamic content using paste0
      dash <- "SeriesDash"
      variables <- unique(metadata$Variable[metadata$Item == i])
      variables <- paste(variables, collapse = ",")
      label <- URLencode(metadata$Question[metadata$Item == i][1], reserved = FALSE)
      label <- gsub(",", "|", label)
      universe <- metadata$Base[metadata$Item == i][1]

      height <- 500
    }
    
    src <- paste0("https://tableau.dsc.umich.edu/t/UM-Public/views/Testingembedding/",
      dash, "?:embed=y&:showVizHome=no&:toolbar=no",
      "&Variable=", variables,
      "&LabelParameter=", label,
      "&UniverseParameter=", universe)

  cat('
  <iframe
  src="',src,'"
    width="100%"
    height="500"
    loading="lazy"
    allowfullscreen>
  </iframe>
  ')

  } #closes item loop
  
  cat('\n::: \n\n')

} #closes section loop

```

::: {.content-visible when-format="pdf"}
```{r pdf-findings}

# For each survey item, print item details and render results

```
:::

```{=html}
<script>
document.addEventListener("DOMContentLoaded", () => {

  // Only collapse headers explicitly tagged with class "section-collapse"
  const headers = document.querySelectorAll("h1.section-collapse");

  headers.forEach(header => {

    const content = [];
    let el = header.nextElementSibling;

    // Gather everything until the next <h1 class="section-collapse">
    while (
      el &&
      !(el.tagName === "H1" && el.classList.contains("section-collapse"))
    ) {
      content.push(el);
      el = el.nextElementSibling;
    }

    // Collapse all content initially
    content.forEach(x => x.classList.add("collapsed-section"));

    // Toggle visibility on click
    header.addEventListener("click", () => {
      const isOpen = header.classList.toggle("open");
      content.forEach(x => {
        x.style.display = isOpen ? "block" : "none";
      });
    });
  });
});
</script>
```
::::
